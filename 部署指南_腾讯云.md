# 服装ERP系统 — 腾讯云部署指南

## 架构概览

```
用户 → 腾讯CDN（可选）→ CVM / 轻量应用服务器 → Next.js 应用（PM2）
                                                → MySQL（云数据库 或 本地安装）
```

**推荐技术栈：**
- 计算：腾讯云 CVM 或 轻量应用服务器
- 数据库：云数据库 MySQL（托管）或 服务器本地安装 MySQL
- 反向代理：Nginx
- 进程管理：PM2
- SSL证书：Let's Encrypt（免费）通过 Certbot 获取

---

## 第一步：购买服务器

1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 创建**轻量应用服务器**（最经济的选择）：
   - 地域：选择与你的云数据库 MySQL 相同的地域
   - 镜像：Ubuntu 22.04 LTS
   - 配置：最低 2核CPU / 4GB内存（可支持约20个并发用户）
   - 存储：60GB SSD 云硬盘
3. 在防火墙中开放端口：**22**（SSH）、**80**（HTTP）、**443**（HTTPS）

---

## 第二步：数据库配置（云数据库 MySQL — 已有）

数据库已经在腾讯云数据库 MySQL 上运行，只需确认：
1. 轻量应用服务器的**内网IP**已添加到云数据库的安全组白名单中
2. 记录好内网连接地址（例如：`sh-cynosdbmysql-grp-xxx.sql.tencentcdb.com:3306`）
3. 数据库 `garment_erp` 已创建，并有专用的数据库用户

---

## 第三步：安装 Node.js 和依赖

```bash
# 安装 Node.js 20 LTS
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 全局安装 PM2 进程管理器
sudo npm install -g pm2

# 安装 Nginx 和 SSL 工具
sudo apt install -y nginx certbot python3-certbot-nginx
```

---

## 第四步：部署应用

```bash
# 创建应用目录
sudo mkdir -p /var/www/garment-erp
sudo chown $USER:$USER /var/www/garment-erp

# 上传代码（从本地电脑执行）：
# scp -r ./Garment\ ERP/* user@服务器IP:/var/www/garment-erp/

# 或者使用 git 拉取：
cd /var/www/garment-erp
git clone <你的仓库地址> .

# 创建环境配置文件
cat > .env << 'EOF'
# 数据库连接 — 使用腾讯云数据库内网地址
DATABASE_URL="mysql://erpadmin:你的密码@sh-cynosdbmysql-grp-xxx.sql.tencentcdb.com:3306/garment_erp"

# JWT 密钥（请替换为随机字符串，至少32位）
JWT_SECRET="替换成你自己的随机密钥至少32个字符"

# 应用配置
NODE_ENV=production
PORT=3000
EOF

# 安装依赖并构建
npm install
npx prisma db push
npm run build

# 初始化数据（仅首次部署时执行）
npm run seed
```

---

## 第五步：使用 PM2 启动应用

```bash
# 启动应用
pm2 start npm --name "garment-erp" -- start

# 设置开机自启动
pm2 startup
pm2 save

# 常用 PM2 命令：
# pm2 logs garment-erp    — 查看日志
# pm2 restart garment-erp — 重启应用
# pm2 status              — 查看状态
# pm2 monit               — 实时监控
```

---

## 第六步：配置 Nginx 反向代理

```bash
sudo nano /etc/nginx/sites-available/garment-erp
```

粘贴以下内容（将 `your-domain.com` 替换为你的域名）：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        client_max_body_size 50M;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/garment-erp /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t && sudo systemctl reload nginx
```

---

## 第七步：开启 HTTPS（SSL证书）

```bash
# 先将域名的 DNS A 记录指向服务器IP，然后执行：
sudo certbot --nginx -d your-domain.com

# 证书会自动续期，无需手动操作
```

---

## 更新应用

当有代码更新时：

```bash
cd /var/www/garment-erp

# 拉取最新代码
git pull origin main

# 安装新增依赖
npm install

# 同步数据库结构变更
npx prisma db push

# 重新构建
npm run build

# 重启应用
pm2 restart garment-erp
```

---

## 费用估算（每月）

| 组件 | 配置 | 大约费用 |
|------|------|----------|
| 轻量应用服务器 2核4G | Ubuntu, 60GB SSD | ¥50-80/月 |
| 云数据库 MySQL | 已有 | （现有费用） |
| 域名 + DNS | .com 域名 | ¥5-10/月 |
| **合计（仅服务器+域名）** | | **¥55-90/月** |

---

## 如果没有域名（仅用IP访问）

跳过第七步的 Certbot 配置，直接通过 `http://服务器IP` 访问即可。如需 HTTPS 但没有域名，可以使用自签名证书，但浏览器会显示安全警告。

---

## 数据备份策略

腾讯云数据库 MySQL 自带自动备份功能。你也可以从服务器手动备份：

```bash
# 创建备份目录
sudo mkdir -p /backup

# 手动备份（通过内网连接云数据库）
mysqldump -h sh-cynosdbmysql-grp-xxx.sql.tencentcdb.com -u erpadmin -p garment_erp > /backup/garment_erp_$(date +%Y%m%d).sql

# 设置定时自动备份（每天凌晨2点）
# 执行 crontab -e，添加以下行：
# 0 2 * * * mysqldump -h sh-cynosdbmysql-grp-xxx.sql.tencentcdb.com -u erpadmin -p你的密码 garment_erp > /backup/garment_erp_$(date +\%Y\%m\%d).sql

# 定期清理30天前的旧备份
# 0 3 * * * find /backup -name "garment_erp_*.sql" -mtime +30 -delete
```

---

## 常见问题排查

| 问题 | 解决方法 |
|------|----------|
| 应用无法启动 | 查看日志：`pm2 logs garment-erp` |
| 数据库连接失败 | 检查 MySQL 状态：`sudo systemctl status mysql` |
| 502 Bad Gateway | 应用崩溃，重启：`pm2 restart garment-erp` |
| 浏览器无法访问 | 检查防火墙：确认端口 80/443 已在腾讯云控制台开放 |
| Prisma 报错（改了数据库结构后） | 执行 `npx prisma db push` 然后 `pm2 restart garment-erp` |
| npm install 太慢 | 使用国内镜像：`npm config set registry https://registry.npmmirror.com` |
| 服务器内存不足 | 添加 swap：`sudo fallocate -l 2G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile` |
